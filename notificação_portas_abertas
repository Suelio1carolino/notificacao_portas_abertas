blueprint:
  name: Notificação Inteligente de Portas Abertas (Corrigido)
  description: |
    Verifica se portas estão abertas em um horário específico, envia notificações
    persistentes repetidas a cada intervalo definido, e limpa automaticamente 
    as notificações quando todas as portas forem fechadas.
    
    VERSÃO CORRIGIDA - sem erros de comparação de datetime
  domain: automation
  input:
    door_sensors:
      name: Sensores das Portas
      description: Selecione todos os sensores de porta que deseja monitorar
      selector:
        entity:
          multiple: true
          filter:
            - domain: binary_sensor
    door_open_state:
      name: Estado quando Porta Aberta
      description: Qual é o estado do sensor quando a porta está ABERTA?
      default: "on"
      selector:
        select:
          options:
            - label: "on (ligado)"
              value: "on"
            - label: "off (desligado)"
              value: "off"
    check_time:
      name: Horário de Verificação Inicial
      description: Horário para verificar se as portas estão abertas
      default: "22:00:00"
      selector:
        time:
    repeat_interval:
      name: Intervalo de Repetição (minutos)
      description: A cada quantos minutos repetir a notificação
      default: 10
      selector:
        number:
          min: 1
          max: 60
          unit_of_measurement: "minutos"
    end_time:
      name: Horário Final
      description: Horário para parar de enviar notificações
      default: "06:00:00"
      selector:
        time:
    notification_service:
      name: Serviço de Notificação
      description: Serviço de notificação para usar (ex. notify.mobile_app_seu_celular)
      default: notify.notify
      selector:
        text:
    notification_title:
      name: Título da Notificação
      description: Título da notificação
      default: "⚠️ Portas Abertas"
      selector:
        text:
    use_persistent:
      name: Usar Notificação Persistente
      description: Criar também uma notificação persistente na interface do Home Assistant
      default: true
      selector:
        boolean:

mode: restart

variables:
  door_sensors: !input door_sensors
  notification_service: !input notification_service
  notification_title: !input notification_title
  use_persistent: !input use_persistent
  door_open_state: !input door_open_state
  
trigger:
  # Verificação inicial no horário definido
  - platform: time
    at: !input check_time
    id: "initial_check"
  
  # Repetição a cada intervalo
  - platform: time_pattern
    minutes: !input repeat_interval
    id: "repeat_check"
  
  # Quando alguma porta mudar de estado
  - platform: state
    entity_id: !input door_sensors
    id: "door_state_change"

action:
  - variables:
      open_doors_list: >
        {% set ns = namespace(doors=[]) %}
        {% for sensor in door_sensors %}
          {% if is_state(sensor, door_open_state) %}
            {% set ns.doors = ns.doors + [state_attr(sensor, 'friendly_name') or sensor] %}
          {% endif %}
        {% endfor %}
        {{ ns.doors }}
      open_doors_text: >
        {% set ns = namespace(doors=[]) %}
        {% for sensor in door_sensors %}
          {% if is_state(sensor, door_open_state) %}
            {% set ns.doors = ns.doors + [state_attr(sensor, 'friendly_name') or sensor] %}
          {% endif %}
        {% endfor %}
        {{ ns.doors | join(', ') }}
      door_count: >
        {% set ns = namespace(count=0) %}
        {% for sensor in door_sensors %}
          {% if is_state(sensor, door_open_state) %}
            {% set ns.count = ns.count + 1 %}
          {% endif %}
        {% endfor %}
        {{ ns.count }}
      all_doors_closed: >
        {{ door_count | int == 0 }}
      current_time: "{{ now().strftime('%H:%M') }}"
      check_time_str: "{{ (states('input_datetime.dummy') if false else check_time)[0:5] }}"
      end_time_str: "{{ (states('input_datetime.dummy') if false else end_time)[0:5] }}"
      is_monitoring_period: >
        {% set current = now().strftime('%H:%M') %}
        {% set start = check_time[0:5] %}
        {% set stop = end_time[0:5] %}
        {% if stop > start %}
          {{ current >= start and current < stop }}
        {% else %}
          {{ current >= start or current < stop }}
        {% endif %}

  - choose:
      # Se todas as portas estão fechadas, limpar notificações
      - conditions:
          - condition: template
            value_template: "{{ all_doors_closed }}"
          - condition: template
            value_template: "{{ is_monitoring_period }}"
          - condition: trigger
            id: "door_state_change"
        sequence:
          - choose:
              - conditions:
                  - condition: template
                    value_template: "{{ use_persistent }}"
                sequence:
                  - service: persistent_notification.dismiss
                    data:
                      notification_id: "portas_abertas_alert"
          
          - service: "{{ notification_service }}"
            data:
              message: "clear_notification"
              data:
                tag: "portas_abertas"

      # Se há portas abertas, enviar notificação
      - conditions:
          - condition: template
            value_template: "{{ not all_doors_closed }}"
          - condition: or
            conditions:
              # Verificação inicial
              - condition: trigger
                id: "initial_check"
              # Repetição periódica durante o período de monitoramento
              - condition: and
                conditions:
                  - condition: trigger
                    id: "repeat_check"
                  - condition: template
                    value_template: "{{ is_monitoring_period }}"
        sequence:
          - choose:
              - conditions:
                  - condition: template
                    value_template: "{{ use_persistent }}"
                sequence:
                  - service: persistent_notification.create
                    data:
                      title: "{{ notification_title }}"
                      message: >
                        {% if door_count == 1 %}
                          A seguinte porta está aberta: {{ open_doors_text }}
                        {% else %}
                          As seguintes {{ door_count }} portas estão abertas: {{ open_doors_text }}
                        {% endif %}
                        
                        Última verificação: {{ now().strftime('%d/%m/%Y %H:%M:%S') }}
                      notification_id: "portas_abertas_alert"
          
          - service: "{{ notification_service }}"
            data:
              title: "{{ notification_title }}"
              message: >
                {% if door_count == 1 %}
                  A seguinte porta está aberta: {{ open_doors_text }}
                {% else %}
                  As seguintes {{ door_count }} portas estão abertas: {{ open_doors_text }}
                {% endif %}
              data:
                tag: "portas_abertas"
                sticky: true
                priority: high
                notification_icon: "mdi:door-open"
