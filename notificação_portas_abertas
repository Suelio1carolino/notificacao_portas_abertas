blueprint:
  name: "Notificação de Portas Abertas - v2.0 Final"
  description: |
    Monitora portas abertas em um período específico. 
    Envia notificações persistentes e limpa-as automaticamente ao fechar.
  domain: automation
  input:
    door_sensors:
      name: Sensores das Portas
      description: Selecione os sensores de porta (binary_sensor).
      selector:
        entity:
          multiple: true
          filter:
            - domain: binary_sensor
    door_open_state:
      name: Estado quando Porta Aberta
      default: "on"
      selector:
        select:
          options:
            - label: "on (ligado)"
              value: "on"
            - label: "off (desligado)"
              value: "off"
    check_time:
      name: Horário de Início
      default: "22:00:00"
      selector:
        time:
    end_time:
      name: Horário de Término
      default: "06:00:00"
      selector:
        time:
    notification_service:
      name: Serviço de Notificação
      description: Ex: notify.mobile_app_seu_celular
      default: notify.notify
      selector:
        text:
    notification_title:
      name: Título da Notificação
      default: "⚠️ Portas Abertas"
      selector:
        text:
    use_persistent:
      name: Usar Notificação no Painel (HA)
      default: true
      selector:
        boolean:

mode: parallel
max: 10

variables:
  # Tornando os inputs acessíveis aos templates
  door_sensors: !input door_sensors
  door_open_state: !input door_open_state
  notification_service: !input notification_service
  notification_title: !input notification_title
  use_persistent: !input use_persistent
  check_time: !input check_time
  end_time: !input end_time

trigger:
  - platform: time
    at: !input check_time
    id: "initial_check"
  - platform: time_pattern
    minutes: "/10"
    id: "repeat_check"
  - platform: state
    entity_id: !input door_sensors
    id: "door_state_change"

action:
  - variables:
      # Lógica otimizada para identificar portas abertas
      open_entities: "{{ door_sensors | select('is_state', door_open_state) | list }}"
      door_count: "{{ open_entities | count }}"
      open_doors_text: "{{ expand(open_entities) | map(attribute='name') | join(', ') }}"
      
      # Verifica se estamos dentro da janela de horário
      is_monitoring_period: >
        {% set current = now().strftime('%H:%M') %}
        {% set start = check_time[0:5] %}
        {% set stop = end_time[0:5] %}
        {% if stop > start %}
          {{ current >= start and current < stop }}
        {% else %}
          {{ current >= start or current < stop }}
        {% endif %}

  - choose:
      # CASO 1: Todas as portas fechadas -> Limpar notificações (Sempre)
      - conditions:
          - condition: template
            value_template: "{{ door_count == 0 }}"
        sequence:
          - if:
              - condition: template
                value_template: "{{ use_persistent }}"
            then:
              - service: persistent_notification.dismiss
                data:
                  notification_id: "portas_abertas_alert"
          - service: "{{ notification_service }}"
            data:
              message: "clear_notification"
              data:
                tag: "portas_abertas"

      # CASO 2: Há portas abertas -> Notificar (Se for horário ou mudança de estado)
      - conditions:
          - condition: template
            value_template: "{{ door_count > 0 }}"
          - condition: or
            conditions:
              - condition: trigger
                id: "initial_check"
              - condition: and
                conditions:
                  - condition: trigger
                    id: "repeat_check"
                  - condition: template
                    value_template: "{{ is_monitoring_period }}"
              - condition: and
                conditions:
                  - condition: trigger
                    id: "door_state_change"
                  - condition: template
                    value_template: "{{ is_monitoring_period }}"
        sequence:
          # Notificação no Painel do HA
          - if:
              - condition: template
                value_template: "{{ use_persistent }}"
            then:
              - service: persistent_notification.create
                data:
                  title: "{{ notification_title }}"
                  notification_id: "portas_abertas_alert"
                  message: >
                    {{ 'A seguinte porta está aberta: ' if door_count == 1 else 'As seguintes ' ~ door_count ~ ' portas estão abertas: ' }}
                    {{ open_doors_text }}
                    Verificado em: {{ now().strftime('%H:%M') }}

          # Notificação para o Serviço (Celular)
          - service: "{{ notification_service }}"
            data:
              title: "{{ notification_title }}"
              message: >
                {{ 'Aberta: ' if door_count == 1 else door_count ~ ' portas abertas: ' }} {{ open_doors_text }}
              data:
                tag: "portas_abertas"
                group: "seguranca-portas"
                sticky: true
                priority: high
                icon: "mdi:door-open"
